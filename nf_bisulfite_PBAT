#!/usr/bin/env nextflow

// Enable modules
nextflow.preview.dsl=2

params.outdir = "."
params.genome = ""
params.verbose = false
params.fastqc_args = ''
params.fastq_screen_args = ''
params.trim_galore_args = ''
params.bismark_args = ''
params.deduplicate_bismark_args = ''
params.bismark_methylation_extractor_args = ''

if (params.verbose){
    println ("[WORKFLOW] FASTQC ARGS: "           + params.fastqc_args)
    println ("[WORKFLOW] FASTQ SCREEN ARGS ARE: " + params.fastq_screen_args)
    println ("[WORKFLOW] TRIM GALORE ARGS: "      + params.trim_galore_args)
    println ("[WORKFLOW] BISMARK ARGS ARE: "      + params.bismark_args)
    println ("[WORKFLOW] BISMARK DEDUPLICATION ARGS ARE: "         + params.deduplicate_bismark_args)
    println ("[WORKFLOW] BISMARK METHYLATION EXTRACTOR ARGS ARE: " + params.bismark_methylation_extractor_args)
}
include './nf_modules/files.mod.nf'
include './nf_modules/genomes.mod.nf'
genome = getGenome(params.genome)

include './nf_modules/fastqc.mod.nf'                         
include  FASTQC as FASTQC2 from './nf_modules/fastqc.mod.nf' 

include './nf_modules/fastq_screen.mod.nf'

// Adding pbat flag for PBAT processing. For Trim Galore we pass on the number of bp that need to be clipped at the 5' end
include './nf_modules/trim_galore.mod.nf'                    params(pbat: 9)
// Adding pbat flag for PBAT processing
include './nf_modules/bismark.mod.nf'                        params(genome: genome, pbat: true)

include './nf_modules/bismark_deduplication.mod.nf'

// Adding pbat flag for PBAT processing
include './nf_modules/bismark_methylation_extractor.mod.nf'  params(pbat: true)

file_ch = makeFilesChannel(args)

workflow {

    main:
        FASTQC                          (file_ch, params.outdir, params.fastqc_args, params.verbose)
        FASTQ_SCREEN                    (file_ch, params.outdir, params.fastq_screen_args, params.verbose)
        TRIM_GALORE                     (file_ch, params.outdir, params.trim_galore_args, params.verbose)
        FASTQC2                         (TRIM_GALORE.out.reads, params.outdir, params.fastqc_args, params.verbose)
        BISMARK                         (TRIM_GALORE.out.reads, params.outdir, params.bismark_args, params.verbose)
        BISMARK_DEDUPLICATION           (BISMARK.out.bam, params.outdir, params.deduplicate_bismark_args, params.verbose)
        BISMARK_METHYLATION_EXTRACTOR   (BISMARK_DEDUPLICATION.out.bam, params.outdir, params.bismark_methylation_extractor_args, params.verbose)
}

